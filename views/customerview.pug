doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Young4Chicks - Customers Dashboard
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css")
    link(rel="stylesheet" href="/young-for-chicks/css/bootstrap-5.3.6/css/bootstrap.css")
    link(rel="stylesheet" href="css/bootstrap-5.3.6-dist/css/bootstrap.css")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet")
    style.
      .hexagon {
        position: relative;
        width: 110px;
        height: 60px;
        background: rgba(24, 49, 53, 0.15);
        margin: 10px auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #17a2b8;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        clip-path: polygon(
          25% 5%, 75% 5%,
          100% 50%,
          75% 95%, 25% 95%,
          0% 50%
        );
        transition: transform 0.2s;
      }
      .hexagon:hover {
        transform: scale(1.07);
        box-shadow: 0 4px 16px rgba(0,255,255,0.15);
      }
      .hex-content {
        text-align: center;
        color: #fff;
        width: 100%;
      }
      .hex-content i {
        display: block;
        margin-bottom: 2px;
        font-size: 1.3rem;
      }
      .hex-content div {
        font-size: 0.95rem;
        font-weight: 500;
      }
      /* Zigzag pattern */
      .zigzag-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: nowrap;
        width: 100%;
        margin: 0;
        padding: 0 2vw;
      }
      .zigzag-row .zigzag-col {
        flex: 1 1 0;
        display: flex;
        justify-content: center;
        margin-bottom: -18px; /* overlap hexagons vertically */
      }
      .zigzag-row.even {
        margin-left: 6vw;
      }
      @media (max-width: 991px) {
        .zigzag-row {
          flex-wrap: wrap;
          justify-content: center;
          padding: 0;
        }
        .zigzag-row.even {
          margin-left: 0;
        }
      }
      @media (max-width: 767px) {
        .zigzag-row, .zigzag-row.even {
          flex-wrap: wrap;
          margin-left: 0 !important;
          margin-bottom: 0;
          padding: 0;
        }
        .zigzag-row .zigzag-col {
          margin-bottom: 0;
        }
        .hexagon {
          width: 90px;
          height: 48px;
        }
      }
      .zigzag-menu-fixed {
        position: sticky;
        top: 0;
        z-index: 1050;
        background: black;
        padding-top: 10px;
        padding-bottom: 10px;
      }
  body(style="background-color: darkgreen;")
    // Zigzag Hexagon Navigation (fixed at the top)
    .zigzag-menu-fixed
      .w-100.my-4
      .zigzag-row.odd
        .zigzag-col
          a.text-decoration-none(href="/custview")
            .hexagon
              .hex-content
                i.fa.fa-home(style="color: rgb(0, 255, 255);")
                div(style="color: rgb(0, 255, 255);") HOME
        .zigzag-col
          a.text-decoration-none(href="/")
            .hexagon
              .hex-content
                i.fa.fa-sign-out-alt(style="color: #0d6efd;")
                div(style="color: #0d6efd;") LOGOUT
    script(src="css/bootstrap-5.3.6/js/bootstrap.bundle.js")
    script(src="/young-for-chicks/js/include.js")
    .container.mt-4
      .row
        .col-12
          .card.border-info(style="background-color: rgba(24, 49, 53, 0.068);")
            .card-header.d-flex.justify-content-between.align-items-center
              h4(style="color: aqua;") Chicken Requests
              button.btn.btn-success.btn-sm(type="button" onclick="showAddForm()")
                i.fa.fa-plus
                | Â Add
            .card-body
              // Add Form (hidden by default)
              form#addRequestForm.mb-3(style="display:none;")
                .row.g-2
                  .col-md-3
                    input#addDate.form-control(type="date" required)
                  .col-md-2
                    input#addChicks.form-control(type="number" placeholder="Total Chicks" min="1" required)
                  .col-md-3
                    input#addFarmer.form-control(type="text" placeholder="Farmer" required)
                  .col-md-2
                    button.btn.btn-primary.btn-sm(type="submit") Save
                    button.btn.btn-secondary.btn-sm(type="button" onclick="hideAddForm()") Cancel
              table.table.table-striped
                thead
                  tr
                    th Date Submitted
                    th Total Chicks
                    th Farmer
                    th Total Price
                    th Approved
                    th Actions
                tbody#requestsTableBody
                  // Filled by JS
    .container-fluid.mt-4
      .row.mb-4
        // Chicks
        .col-md-4
          .card.border-warning(style="background-color: rgba(24, 49, 53, 0.068);")
            .card-header
              h4(style="color: aqua;") Total Chicks
            .card-body
              h5(style="color: chartreuse;")
                span#totalChicksCount 0
        // Users
        .col-md-4
          .card.border-info(style="background-color: rgba(0, 0, 0, 0);")
            .card-header
              h4(style="color: aqua;") Total Users
            .card-body
              h5(style="color: chartreuse;")
                span#totalUsersCount 0
        // Requests
        .col-md-4
          .card.border-warning(style="background-color: rgba(24, 49, 53, 0.068);")
            .card-header
              h4(style="color: aqua;") Total Requests
            .card-body
              h5(style="color: chartreuse;")
                span#totalRequestsCount 0

      // Feeds Section - Added to fix the error
      .row.mb-4
        .col-md-4
          .card.border-warning(style="background-color: rgba(24, 49, 53, 0.068);")
            .card-header
              h4(style="color: aqua;") Total Feeds
            .card-body
              table.table.table-striped
                thead
                  tr
                    th Feed Type
                    th Kgs
                tbody#feedsTableBody
                  // Filled by JS
              h5.mt-3(style="color: chartreuse;")
                | Total Kgs: 
                span#totalFeedsKgs 0
        // Placeholder for other sections if needed to maintain layout
        .col-md-8
          // This column is left empty to balance the row if you only add feeds to one side
          // You can add other content here if desired
          
      // Payments Tables
      .row.mt-4
        .col-md-6
          .card
            .card-header.bg-primary.text-white Bank Payments
            .card-body
              form#addBankPaymentForm.mb-2
                input#bankName.form-control.mb-2(type="text" placeholder="Name of farmer" required)
                input#bankAmount.form-control.mb-2(type="number" placeholder="Add Bank Payment" required)
                select#bankNotes.form-select.mb-2(required)
                  option(value="broilers") broilers
                  option(value="layers") layers
                  option(value="exotic") exotic
                button.btn.btn-success.btn-sm(type="submit") Add
              table.table.table-striped
                thead
                  tr
                    th Send receipt to
                    th sales@y4c.com
                    th
                    th
                    th
                tbody#bankPaymentsTableBody
        .col-md-6
          .card
            .card-header.bg-primary.text-white MOMO Payments
            .card-body
              form#addMomoPaymentForm.mb-2
                input#momoName.form-control.mb-2(type="text" placeholder="Name of farmer" required)
                input#momoAmount.form-control.mb-2(type="number" placeholder="Add MOMO Payment" required)
                select#momoNotes.form-select.mb-2(required)
                  option(value="broilers") broilers
                  option(value="layers") layers
                  option(value="exotic") exotic
                button.btn.btn-success.btn-sm(type="submit") Add
              table.table.table-striped
                thead
                  tr
                    th Send receipt to
                    th sales@y4c.com
                    th
                    th
                tbody#momoPaymentsTableBody
      // All Payments Table (NEW)
      .card.mt-4
        .card-header.bg-secondary.text-white All Payments Submitted
        .card-body
          table.table.table-striped
            thead
              tr
                th Payer
                th Amount
                th Method
                th Date
                th Notes
            tbody#allPaymentsTableBody
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js")
    script.
      // --- FEEDS TABLE ---
      async function loadFeedsTable() {
        try {
          const res = await fetch('/api/feeds');
          if (!res.ok) throw new Error('Failed to fetch feeds');
          const feeds = await res.json();
          const tbody = document.getElementById('feedsTableBody');
          const totalKgsSpan = document.getElementById('totalFeedsKgs'); // Get the total Kgs span
          
          // Ensure elements exist before trying to manipulate them
          if (!tbody) {
            console.error("Element with ID 'feedsTableBody' not found.");
            return;
          }
          if (!totalKgsSpan) {
            console.error("Element with ID 'totalFeedsKgs' not found.");
            return;
          }

          tbody.innerHTML = '';
          let totalKgs = 0;
          if (feeds.length === 0) {
            tbody.innerHTML = `<tr><td colspan="2" style="color:gray;">No feeds found</td></tr>`;
          } else {
            feeds.forEach(feed => {
              let kgs = parseInt(feed.kgs) || 0;
              totalKgs += kgs;
              // Safe fallback for feed name
              let feedName = (typeof feed.totalFeeds === 'string' && feed.totalFeeds.trim() && feed.totalFeeds !== 'undefined') ? feed.totalFeeds : 'Feed';
              tbody.innerHTML += `<tr><td>${feedName}</td><td>${kgs}</td></tr>`;
            });
          }
          totalKgsSpan.textContent = totalKgs; // Set text content for the span
        } catch (err) {
          alert('Error loading feeds: ' + err.message);
        }
      }
      // --- PENDING CHICKEN REQUESTS TABLE (CLONED FUNCTIONALITY) ---
      async function fetchRequests() {
        try {
          const res = await fetch('/admin/requests');
          if (!res.ok) throw new Error('Failed to fetch requests');
          return await res.json();
        } catch (err) {
          alert('Error loading requests: ' + err.message);
          return [];
        }
      }
      async function loadRequestsTable() {
        const requests = await fetchRequests();
        const tbody = document.getElementById('pendingRequestsTableBody'); // This ID is not in your HTML
        // Correcting to 'requestsTableBody' as per your HTML
        const requestsTableBody = document.getElementById('requestsTableBody'); 
        if (!requestsTableBody) {
          console.error("Element with ID 'requestsTableBody' not found.");
          return;
        }

        requestsTableBody.innerHTML = '';
        if (requests.length === 0) {
          requestsTableBody.innerHTML = `<tr><td colspan="6" style="color:gray;">No pending requests</td></tr>`;
        } else {
          requests.forEach((r, i) => {
            let totalPrice = (parseInt(r.chicks) || 0) * 1650;
            requestsTableBody.innerHTML += `
              <tr>
                <td>${r.date || ''}</td>
                <td>${r.chicks || 0}</td>
                <td>${r.farmer || ''}</td>
                <td>${totalPrice}</td>
                <td>${r.approved ? 'Yes' : 'No'}</td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="deleteRequest('${r._id}')">Delete</button>
                </td>
              </tr>
            `;
          });
        }
      }
      async function deleteRequest(id) {
        if (!confirm('Are you sure you want to delete this request?')) return;
        try {
          const res = await fetch(`/admin/requests/${id}`, { method: 'DELETE' });
          if (!res.ok) throw new Error('Failed to delete request');
          loadRequestsTable();
        } catch (err) {
          alert('Error deleting request: ' + err.message);
        }
      }
      // Optionally, implement editRequest if you want edit functionality
      function editRequest(id) {
        alert('Edit functionality not implemented yet for request ID: ' + id);
      }
      // --- PAYMENTS TABLES ---
      async function loadBankPayments() {
        const res = await fetch('/api/payments/bank');
        if (!res.ok) return;
        const payments = await res.json();
        const tbody = document.getElementById('bankPaymentsTableBody');
        if (!tbody) {
          console.error("Element with ID 'bankPaymentsTableBody' not found.");
          return;
        }
        tbody.innerHTML = payments.map(pay => `
          <tr>
            <td>${pay.name}</td>
            <td>${pay.amount}</td>
            <td>
              <select class="form-select" disabled>
                <option${pay.notes === 'broilers' ? ' selected' : ''}>broilers</option>
                <option${pay.notes === 'layers' ? ' selected' : ''}>layers</option>
                <option${pay.notes === 'exotic' ? ' selected' : ''}>exotic</option>
              </select>
            </td>
            <td></td>
          </tr>
        `).join('');
      }
      async function loadMomoPayments() {
        const res = await fetch('/api/payments/momo');
        if (!res.ok) return;
        const payments = await res.json();
        const tbody = document.getElementById('momoPaymentsTableBody');
        if (!tbody) {
          console.error("Element with ID 'momoPaymentsTableBody' not found.");
          return;
        }
        tbody.innerHTML = payments.map(pay => `
          <tr>
            <td>${pay.name}</td>
            <td>${pay.amount}</td>
            <td>
              <select class="form-select" disabled>
                <option${pay.notes === 'broilers' ? ' selected' : ''}>broilers</option>
                <option${pay.notes === 'layers' ? ' selected' : ''}>layers</option>
                <option${pay.notes === 'exotic' ? ' selected' : ''}>exotic</option>
              </select>
            </td>
            <td></td>
          </tr>
        `).join('');
      }
      // --- ALL PAYMENTS TABLE (NEW) ---
      async function loadAllPaymentsTable() {
        try {
          const res = await fetch('/payments/all');
          if (!res.ok) throw new Error('Failed to fetch all payments');
          const payments = await res.json();
          const tbody = document.getElementById('allPaymentsTableBody');
          if (!tbody) {
            console.error("Element with ID 'allPaymentsTableBody' not found.");
            return;
          }
          tbody.innerHTML = '';
          if (payments.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="color:gray;">No payments submitted</td></tr>`;
          } else {
            payments.forEach(pay => {
              tbody.innerHTML += `
                <tr>
                  <td>${pay.payer || ''}</td>
                  <td>${pay.amount || ''}</td>
                  <td>${pay.method || ''}</td>
                  <td>${pay.date ? new Date(pay.date).toLocaleDateString() : ''}</td>
                  <td>
                    <select class="form-select" disabled>
                      <option${pay.notes === 'broilers' ? ' selected' : ''}>broilers</option>
                      <option${pay.notes === 'layers' ? ' selected' : ''}>layers</option>
                      <option${pay.notes === 'exotic' ? ' selected' : ''}>exotic</option>
                    </select>
                  </td>
                </tr>
              `;
            });
          }
        } catch (err) {
          alert('Error loading all payments: ' + err.message);
        }
      }
      // --- INIT ---
      window.addEventListener('DOMContentLoaded', () => {
        loadFeedsTable();
        loadBankPayments();
        loadMomoPayments();
        loadRequestsTable(); // Changed from loadRequests
        loadAllPaymentsTable();
      });

      // Add Request Modal functionality (button removed, so modal won't be triggered)
      // If you want to trigger the modal elsewhere, add your own trigger code.

      // Corrected: The add request form's elements were `addDate`, `addChicks`, `addFarmer`
      // but the submit handler used `requestDate`, `requestChicks`, `requestFarmer`.
      // Adjusted the submit handler to use the correct IDs.
      document.getElementById('addRequestForm').onsubmit = async function(e) {
        e.preventDefault();
        const date = document.getElementById('addDate').value; // Corrected ID
        const chicks = parseInt(document.getElementById('addChicks').value); // Corrected ID
        const farmer = document.getElementById('addFarmer').value.trim(); // Corrected ID
        if (!date || isNaN(chicks) || chicks < 1 || !farmer) return alert('All fields required');
        try {
          const res = await fetch('/admin/requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date, chicks, farmer })
          });
          if (res.ok) {
            // If you had a Bootstrap modal for addRequest, you would hide it here.
            // Since there's no modal defined, we just hide the form directly.
            hideAddForm();
            loadRequests(); // Call the loadRequests function from the second script block
          } else {
            alert('Failed to submit request');
          }
        } catch (err) {
          alert('Failed to submit request');
        }
      };

      // Bank Payment Form Submission
      document.getElementById('addBankPaymentForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('bankName').value.trim();
        const amount = parseFloat(document.getElementById('bankAmount').value);
        const notes = document.getElementById('bankNotes').value;
        if (!name || isNaN(amount) || !notes) return alert('All fields required');
        const res = await fetch('/api/payments/bank', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, amount, notes })
        });
        if (res.ok) {
          this.reset();
          loadBankPayments();
          loadAllPaymentsTable();
        } else {
          alert('Failed to submit payment');
        }
      };

      // MOMO Payment Form Submission
      document.getElementById('addMomoPaymentForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('momoName').value.trim();
        const amount = parseFloat(document.getElementById('momoAmount').value);
        const notes = document.getElementById('momoNotes').value;
        if (!name || isNaN(amount) || !notes) return alert('All fields required');
        const res = await fetch('/api/payments/momo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, amount, notes })
        });
        if (res.ok) {
          this.reset();
          loadMomoPayments();
          loadAllPaymentsTable();
        } else {
          alert('Failed to submit payment');
        }
      };
    script.
      // Fetch and display admin requests from the backend
      async function fetchRequests() {
          try {
              const res = await fetch('/admin/requests');
              if (!res.ok) throw new Error('Failed to fetch requests');
              return await res.json();
          } catch (err) {
              alert('Error loading requests: ' + err.message);
              return [];
          }
      }

      async function loadRequests() { // Renamed from loadRequestsTable in the first block to avoid conflict and maintain consistency
          const requests = await fetchRequests();
          const tbody = document.getElementById('requestsTableBody');
          if (!tbody) {
            console.error("Element with ID 'requestsTableBody' not found for loadRequests().");
            return;
          }
          tbody.innerHTML = '';
          requests.forEach((r, i) => {
              let totalPrice = (parseInt(r.chicks) || 0) * 1650;
              let checked = r.approved ? 'checked' : '';
              tbody.innerHTML += `
                  <tr id="requestRow${r._id}">
                      <td><span class="request-date">${r.date}</span></td>
                      <td><span class="request-chicks">${r.chicks}</span></td>
                      <td><span class="request-farmer">${r.farmer}</span></td>
                      <td><span class="request-price">${totalPrice}</span></td>
                      <td>
                          <input type="checkbox" ${checked} disabled title="Can only be approved by admin">
                      </td>
                      <td>
                          <button class="btn btn-primary btn-sm" onclick="alert('Consult Sales Rep')">Edit</button>
                          <button class="btn btn-danger btn-sm" onclick="alert('Consult Sales Rep ')">Delete</button>
                      </td>
                  </tr>
              `;
          });
          updateStats(requests);
      }
      function showAddForm() {
          document.getElementById('addRequestForm').style.display = '';
      }
      function hideAddForm() {
          document.getElementById('addRequestForm').reset();
          document.getElementById('addRequestForm').style.display = 'none';
      }

      // This submit handler is a duplicate of the one in the first script block.
      // I've kept it as is for now, but in a real app, you'd want to consolidate.
      document.getElementById('addRequestForm').onsubmit = async function(e) {
          e.preventDefault();
          let date = document.getElementById('addDate').value;
          let chicks = document.getElementById('addChicks').value;
          let farmer = document.getElementById('addFarmer').value.trim();
          if (!date || !chicks || !farmer) return alert('All fields required');
          try {
              const res = await fetch('/admin/requests', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ date, chicks, farmer, agent: '', approved: false })
              });
              if (!res.ok) throw new Error('Failed to add request');
              loadRequests();
              hideAddForm();
          } catch (err) {
              alert('Error adding request: ' + err.message);
          }
      };


      // Edit and delete are disabled for dashboard; show alert instead

      async function toggleApproved(id, isChecked) {
          try {
              const res = await fetch(`/admin/requests/${id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ approved: isChecked })
              });
              if (!res.ok) throw new Error('Failed to update approval');
              loadRequests();
          } catch (err) {
              alert('Error updating approval: ' + err.message);
          }
      }

      // Update stats: total chicks, total users, total requests (sum of total price)
      function updateStats(requests) {
          // Total chicks
          let totalChicks = requests.reduce((sum, r) => sum + (parseInt(r.chicks) || 0), 0);
          const totalChicksEl = document.getElementById('totalChicksCount');
          if (totalChicksEl) totalChicksEl.textContent = totalChicks;
          // Total users (unique farmers)
          let farmers = requests.map(r => r.farmer && r.farmer.trim()).filter(Boolean);
          let uniqueFarmers = [...new Set(farmers)];
          const totalUsersEl = document.getElementById('totalUsersCount');
          if (totalUsersEl) totalUsersEl.textContent = uniqueFarmers.length;
          // Total requests (sum of total price)
          let totalPriceSum = requests.reduce((sum, r) => sum + ((parseInt(r.chicks) || 0) * 1650), 0);
          const totalRequestsEl = document.getElementById('totalRequestsCount');
          if (totalRequestsEl) totalRequestsEl.textContent = totalPriceSum;
      }

      // Initial load
      window.onload = function() {
          loadRequests(); // Call the function to load requests table
          loadFeedsTable(); // Ensure feeds table is also loaded on window load
          loadBankPayments();
          loadMomoPayments();
          loadAllPaymentsTable();
      };
    script(src="css/bootstrap-5.3.6-dist/js/bootstrap.bundle.js")